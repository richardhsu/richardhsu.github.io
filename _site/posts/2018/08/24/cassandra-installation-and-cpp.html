<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <title>Cassandra Installation and C++ with Auth</title>
  <meta name="author" content="Richard Hsu">
  <meta name="keywords" content="richard hsu, blog, ideas, thoughts, performance" />
  <meta name="description" content="Exploring life, coding, food, and adventures!" />
  <meta name="viewport" content="width=device-width" />
  <meta name="google-site-verification" content="OmxMsLFmNXKOxX9hZRyFW9sZcita0lpB6lfqUuZQxZs" />
  <link href="https://fonts.googleapis.com/css?family=Karla:400,400i,700,700i" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://www.richardhsu.me/css/syntax.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="https://www.richardhsu.me/css/style.css" type="text/css" media="screen, projection" />
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <link rel="shortcut icon" href="https://www.richardhsu.me/images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="header">
  <div class="container">
    <div class="content-jar clearfix center">
      <div class="avatar"><img src="https://www.richardhsu.me/images/profile.png" height="100" width="100" /></div>
      <div class="description">
        <strong>Exploring life, coding, food, and adventures!</strong>
      </div>
      <ul class="pages">
        <li><a href="https://www.richardhsu.me/"><i class="fa fa-home"></i> Home</a></li>
        <li><a href="https://www.richardhsu.me/tag/"><i class="fa fa-tag"></i> Tags</a></li>
        <li><a href="https://www.richardhsu.me/search/"><i class="fa fa-search"></i> Search Blog</a></li>
      </ul>
    </div>
  </div>
</div>
<div id="feed">
  <div class="container">
    <div class="content-jar">
      <!-- Beginning of Posts Listing -->
      <div class="back-to-index"><a href="https://www.richardhsu.me">Back to Index</a></div>
<div class="post single-post">
  <div class="post-header">
    <h1><a href="/posts/2018/08/24/cassandra-installation-and-cpp.html">Cassandra Installation and C++ with Auth</a></h1>
    <span class="post-date"><i class="fa fa-calendar"></i> August 24, 2018</span>
    <span class="post-tags"><i class="fa fa-tag"></i>
      
      <a href="/tag/tutorial" rel="tag">Tutorial</a>, 
      
      <a href="/tag/cassandra" rel="tag">Cassandra</a>, 
      
      <a href="/tag/c++" rel="tag">C++</a>
      
    </span>
  </div>
  <p>I had the opportunity to experiment with Cassandra at one point and figured it was worth sharing my experience with
getting started on it. There&#39;s a good amount of documentation on it, but figured my distilled learnings here could be
helpful for others. At the very basic, I think Cassandra is great, it&#39;s a key value store has some origins from the
<a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo</a> paper. I&#39;ve also worked a lot with DynamoDB so it&#39;s interesting to compare, though they aren&#39;t
completely the same.</p>

<!--more-->

<h2>Introduction</h2>

<p>From <a href="http://cassandra.apache.org/">Apache Cassandra website</a>:</p>

<blockquote>
<p>The Apache Cassandra database is the right choice when you need scalability and high availability without
compromising performance. Linear scalability and proven fault-tolerance on commodity hardware or cloud infrastructure
make it the perfect platform for mission-critical data. Cassandra&#39;s support for replicating across multiple datacenters
is best-in-class, providing lower latency for your users and the peace of mind of knowing that you can survive
regional outages.</p>
</blockquote>

<p>I was surprised to learn it was based on the Dynamo paper although has different design decisions as it&#39;s grown. But
at the very basic it reminded me a lot about DynamoDB in the beginning before I knew of this. But what was also
interesting about my experimenting with Cassandra was also playing around with the performance with a traditionally
relational design.</p>

<p>Overall it&#39;s scalable and fault-tolerant and very performant. I was able to play around with it in AWS and set up a
cluster spanning California to Virginia and seeing latencies around 300ms for client requests was great! There&#39;s a lot
of material on Cassandra so I won&#39;t go into those details as other sites can do a much better job as well as discussing
trade-offs with other competitors etc.</p>

<h2>Installation on Ubuntu</h2>

<p>This isn&#39;t as interesting because like all great software, Cassandra actually gives clear cut installation instructions!
Honestly, I don&#39;t know why not all sites have easy to follow guides like this, so you can see it at
<a href="http://cassandra.apache.org/doc/latest/getting_started/installing.html">Cassandra&#39;s Getting Started Guide</a>.</p>

<p>At the basic level, I first tested around on a single machine. I generally use <a href="https://www.vagrantup.com/">Vagrant</a> for my development
needs and <a href="https://saltstack.com/">SaltStack</a> for provisioning which also I am familiar with in production environment.</p>

<h3>Salt Configuration</h3>

<p>For those curious, since this may be more interesting is trying to convert this into a salt state. This was the salt
configuration I used for my vagrant machine (YAML file, see configuration for details):</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">cassandra-pkg</span><span class="pi">:</span>
  <span class="s">pkgrepo.managed</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">humanname</span><span class="pi">:</span> <span class="s">Cassandra PPA</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">deb http://www.apache.org/dist/cassandra/debian 311x main</span>
    <span class="pi">-</span> <span class="na">dist</span><span class="pi">:</span> <span class="s">311x</span>
    <span class="pi">-</span> <span class="na">file</span><span class="pi">:</span> <span class="s">/etc/apt/sources.list.d/cassandra.sources.list</span>
    <span class="pi">-</span> <span class="na">key_url</span><span class="pi">:</span> <span class="s">https://www.apache.org/dist/cassandra/KEYS</span>
  <span class="s">pkg.installed</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cassandra</span>

<span class="s">/etc/cassandra/cassandra.yaml</span><span class="pi">:</span>
  <span class="s">file.managed</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">source</span><span class="pi">:</span> <span class="s">salt://cassandra/cassandra.yaml</span>

<span class="na">cassandra</span><span class="pi">:</span>
  <span class="s">service.running</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">enable</span><span class="pi">:</span> <span class="s">True</span>
    <span class="pi">-</span> <span class="na">init_delay</span><span class="pi">:</span> <span class="s">5</span>
    <span class="pi">-</span> <span class="na">watch</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">file</span><span class="pi">:</span> <span class="s">/etc/cassandra/cassandra.yaml</span>

<span class="c1"># Install CPP Drivers (DataStax)</span>
<span class="na">cassandra-cpp-pkgs</span><span class="pi">:</span>
  <span class="s">pkg.latest</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">pkgs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">cmake</span>
      <span class="pi">-</span> <span class="s">build-essential</span>
      <span class="pi">-</span> <span class="s">libssl-dev</span>
      <span class="pi">-</span> <span class="s">libuv1-dev</span>

<span class="s">/opt/install/cassandra-cpp</span><span class="pi">:</span>
  <span class="s">git.latest</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">https://github.com/datastax/cpp-driver.git</span>
    <span class="pi">-</span> <span class="na">rev</span><span class="pi">:</span> <span class="s">2.9.0</span>
    <span class="pi">-</span> <span class="na">target</span><span class="pi">:</span> <span class="s">/opt/install/cassandra-cpp</span>
    <span class="pi">-</span> <span class="na">force_checkout</span><span class="pi">:</span> <span class="s">True</span>
    <span class="pi">-</span> <span class="na">force_reset</span><span class="pi">:</span> <span class="s">True</span>

<span class="s">cassandra-cpp.install</span><span class="pi">:</span>
  <span class="s">cmd.wait</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ldconfig</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">cd</span><span class="nv"> </span><span class="s">/opt/install/cassandra-cpp</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">mkdir</span><span class="nv"> </span><span class="s">build</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">cd</span><span class="nv"> </span><span class="s">build</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">cmake</span><span class="nv"> </span><span class="s">..</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">make</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">make</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">ldconfig"</span>
    <span class="pi">-</span> <span class="na">watch</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">git</span><span class="pi">:</span> <span class="s">/opt/install/cassandra-cpp</span>
</code></pre></div>
<h2>Configuration</h2>

<p>Below are the various settings I changed for my experiment. In most part I had the following configuration:</p>

<ul>
<li>For vagrant, it was just a single machine so nothing too special</li>
<li>For experiment, I had 3 regions (California, Oregon, Virginia) and in each region there were 3 nodes which were
distributed amongst the various availability zones.</li>
</ul>

<p>The following were updated in the <code>cassandra.yaml</code> configuration file:</p>

<h3>Step 1: Change the Cluster Name</h3>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">cluster_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">CassandraExperimentCluster'</span>
</code></pre></div>
<p>I ended up giving the cluster a different name since the default is <code>Test Cluster</code>. Oh how a headache this gave.
Apparently once Cassandra service starts up it fixes this cluster name in the system configuration! So in order to
properly start up the new cluster, you&#39;ll likely need to do the following <strong>after</strong> you&#39;ve finished modifying the YAML
configuration file:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>service cassandra stop
<span class="nb">sudo </span>rm <span class="nt">-rf</span> /var/lib/cassandra/data/system/<span class="k">*</span>
</code></pre></div>
<p>This allows Cassandra to pick up the new configuration and changes the cluster name rather than using the old one.
<strong>Warning:</strong> This will delete all the data, so do this as soon as possible once you&#39;ve configured the YAML file.</p>

<blockquote>
<p>For vagrant, I used the value <code>Test Cluster</code> still since that&#39;s just easiest otherwise have to deal with the system
data purge for Cassandra</p>
</blockquote>

<h3>Step 2: Change the Snitch Endpoint</h3>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">endpoint_snitch</span><span class="pi">:</span> <span class="s">GossipingPropertyFileSnitch</span>
</code></pre></div>
<p>This Snitch allows the nodes to &quot;gossip&quot; and have protocol for determining datacenter and rack information for the
cluster. This is described more in detail in the YAML file so you can choose a different one, such as
<code>Ec2MultiRegionSnitch</code> if you&#39;re on AWS. I didn&#39;t use this since I used all internal IPs and wasn&#39;t sure if the
<code>Ec2MultiRegionSnitch</code> would work without the public IPs.</p>

<blockquote>
<p>For vagrant, I used the value <code>SimpleSnitch</code> as default since there&#39;s only one node.</p>
</blockquote>

<h3>Step 3: Change Seed Providers</h3>

<p>The seed providers only need to be a few of the nodes, not all of them. I elected a single node in each region to be
the seeds, ended up just being first machines I brought up in each region. Then I grabbed their internal IPs:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">seed_provider</span><span class="pi">:</span>
    <span class="c1"># Addresses of hosts that are deemed contact points.</span>
    <span class="c1"># Cassandra nodes use this list of hosts to find each other and learn</span>
    <span class="c1"># the topology of the ring.  You must change this if you are running</span>
    <span class="c1"># multiple nodes!</span>
    <span class="pi">-</span> <span class="na">class_name</span><span class="pi">:</span> <span class="s">org.apache.cassandra.locator.SimpleSeedProvider</span>
      <span class="na">parameters</span><span class="pi">:</span>
          <span class="c1"># seeds is actually a comma-delimited list of addresses.</span>
          <span class="c1"># Ex: "&lt;ip1&gt;,&lt;ip2&gt;,&lt;ip3&gt;"</span>
          <span class="pi">-</span> <span class="na">seeds</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.0.0.1,10.0.1.2,10.0.2.3"</span>
</code></pre></div>
<p>The IPs above are just examples but since they were in 3 different regions, I had 3 different subnets which is why
the internal IPs aren&#39;t all on same subnet.</p>

<blockquote>
<p>For vagrant, the default of <code>127.0.0.1</code> was still maintained since there weren&#39;t any real nodes talking to other
nodes and it&#39;d be the only seed anyways.</p>
</blockquote>

<h3>Step 4: Change the Listening and RPC addresses</h3>

<p>This was an interesting point, I didn&#39;t change all the IPs correctly to the corresponding machines so when I first
connected to the cluster, it&#39;d throw error trying to &quot;connect&quot; to <code>127.0.0.1</code> in the production environment which
didn&#39;t make sense since the client wasn&#39;t running a Cassandra node. But it was because one of my nodes didn&#39;t have
all the addresses set in the configuration so when it connected to the cluster, it was told to connect to that node
and that node said to use <code>127.0.0.1</code>.</p>

<p>For each node, I configured the addresses to be based on its internal IP address, so in this snippet it&#39;s for node
with the IP of <code>10.0.0.3</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">listen_address</span><span class="pi">:</span> <span class="s">10.0.0.3</span>
<span class="na">rpc_address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
<span class="na">broadcast_rpc_address</span><span class="pi">:</span> <span class="s">10.0.0.3</span>
</code></pre></div>
<p>Note, the documentation states that you don&#39;t want to expose to the internet, so I actually have Firewall as well as
the fact that the machines are on an internal network. (I use a bastion machine to connect to the nodes)</p>

<blockquote>
<p>For vagrant, this is just the defaults of <code>localhost</code> and the <code>broadcast_rpc_address</code> is commented out still.</p>
</blockquote>

<p>This allows it to communicate across machines and with client; however, make sure you have the right ports open, in
general I ended up opening the following ports:</p>

<ul>
<li>7000 - For inter-node cluster gossip communication</li>
<li>7001 - For SSL inter-node cluster communication (Although I didn&#39;t set up SSL yet)</li>
<li>7199 - For JMX monitoring</li>
<li>9042 - For CQL client communications (clients and <code>cqlsh</code>)</li>
</ul>

<h3>Step 5: Change the DC and Rack Properties</h3>

<p>The above was for the <code>cassandra.yaml</code> file, this next bit is just for the <code>cassandra-rackdc.properties</code> file:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">dc=us-west-1</span>
<span class="s">rack=us-west-1b</span>
</code></pre></div>
<p>This was interesting, but I ended up assigning the <code>dc</code> or <code>datacenter</code> to be the region name from AWS and the <code>rack</code>
to be the availability zone since that&#39;s best guarantee can get similar to a rack setup.</p>

<hr>

<p>At this point, we&#39;ve configured what we can, and can now start up the nodes again.</p>

<ul>
<li>First start up each seed node one by one with <code>sudo service cassandra start</code></li>
<li>Then start up the remaining nodes once all seeds are up and running. You can use <code>nodetool status</code> to see the nodes
and how they are doing.</li>
</ul>

<h2>Testing with CQLSH</h2>

<p>Cassandra comes with an interactive shell that you can use called <code>cqlsh</code>. It&#39;s nice and handy and it comes with the
installation of Cassandra through the package. If you want it on a separate machine you can install it through <code>pip</code>:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get install python-pip
pip install cassandra-driver
pip install cqlsh
</code></pre></div>
<p>From there I used <code>CQLSH_NO_BUNDLED=true cqlsh -u cassandra -p cassandra</code> in order to connect and you&#39;ll see the
console:</p>
<div class="highlight"><pre><code class="language-" data-lang="">cassandra@cqlsh&gt;
</code></pre></div>
<h3>Setting Up User and Keyspace</h3>

<p>At this point Cassandra is running and things are looking good. Now let&#39;s first set up a separate user from the default:</p>

<h4>Step 1: Modify System Data to Replicate</h4>

<p>First modify the <code>system_auth</code> to replicate, this is important, otherwise you&#39;ll get authorization issues or even
update issues when trying to modify or add a role:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="n">KEYSPACE</span> <span class="n">system_auth</span> <span class="k">WITH</span> <span class="n">REPLICATION</span> <span class="o">=</span> <span class="err">{</span> <span class="s1">'class'</span><span class="p">:</span> <span class="s1">'NetworkTopologyStrategy'</span><span class="p">,</span> <span class="s1">'us-west-1'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'us-west-2'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'us-east-1'</span><span class="p">:</span> <span class="mi">2</span> <span class="err">}</span>
</code></pre></div>
<p>I ended up using a replication factor of 2 since there are 3 nodes in each region. The formatting is generally the
datacenter name and then replication factor. The higher the replication factor, the more gossip will occur so just
think about that tradeoff. For authentication, you could put it at highest if wanted since that&#39;s fairly important,
but for your other keyspaces, changing it to your desired effect may be best.</p>

<h4>Step 2: Add New User</h4>

<p>Next you can now add your new user with the password:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">experiment</span> <span class="k">WITH</span> <span class="n">SUPERUSER</span> <span class="o">=</span> <span class="k">true</span> <span class="k">AND</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="k">true</span> <span class="k">AND</span> <span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">'&lt;PASSWORD_HERE&gt;'</span><span class="p">;</span>
</code></pre></div>
<h4>Step 3: Change Cassandra&#39;s Default Password</h4>

<p>Finally you can change <code>cassandra</code> default password:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="k">USER</span> <span class="n">cassandra</span> <span class="k">WITH</span> <span class="n">PASSWORD</span> <span class="s1">'&lt;RANDOM_PASSWORD&gt;'</span><span class="p">;</span>
</code></pre></div>
<h4>Step 4: Set up Keyspace</h4>

<p>Finally set up your new keyspace:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="n">KEYSPACE</span> <span class="n">experimentapp</span> <span class="k">WITH</span> <span class="n">REPLICATION</span> <span class="o">=</span> <span class="err">{</span> <span class="s1">'class'</span><span class="p">:</span> <span class="s1">'NetworkTopologyStrategy'</span><span class="p">,</span> <span class="s1">'us-west-1'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'us-west-2'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'us-east-1'</span><span class="p">:</span> <span class="mi">2</span> <span class="err">}</span>
</code></pre></div>
<p>I ended up using same replication set up as the system auth, but you can vary it depending on how you feel. At this
point you can start creating your tables as you normally would in the console. Here&#39;s quick example for users:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">experimentapp</span><span class="p">.</span><span class="n">users</span> <span class="p">(</span>
  <span class="n">id</span> <span class="n">bigint</span><span class="p">,</span>
  <span class="n">name</span> <span class="n">text</span><span class="p">,</span>
  <span class="n">email</span> <span class="n">text</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">users_email</span> <span class="k">ON</span> <span class="n">experimentapp</span><span class="p">.</span><span class="n">users</span> <span class="p">(</span><span class="n">email</span><span class="p">);</span>
</code></pre></div>
<p>This creates my table with primary key of <code>id</code> that we&#39;d look up users but also an index on <code>email</code> for easy lookups
by <code>email</code>!</p>

<h2>C++ Connection</h2>

<p>So we&#39;ve set up our keyspace and nodes, now we want to connect. There are various clients and drivers that you can use,
but since I like C++ and there&#39;s usually less documentation C++ figured I&#39;d write out my examples of connecting in C++
as some added benefit to the community (<em>hopefully</em>).</p>

<p>On bright side DataStax has some great drivers so I ended up using their <a href="https://github.com/datastax/cpp-driver">C++ Driver</a> which you can
reference their examples for some more details. But the following I felt were some stuff I had to dig through the
documentation more than just using a simple drop in code snippet:</p>

<p>I ended up creating a singleton client class: <code>CassandraSingleton</code> which basically looks like this for
<code>cassandra_singleton.h</code>:</p>
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#pragma once
</span>
<span class="cp">#include &lt;cassandra.h&gt;
#include &lt;string&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CassandraException</span> <span class="o">:</span> <span class="k">public</span> <span class="n">exception</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">CassandraException</span><span class="p">()</span> <span class="k">throw</span><span class="p">()</span> <span class="p">{}</span>
  <span class="k">virtual</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">what</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">"CassandraException"</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">string</span> <span class="n">error_msg_</span><span class="p">;</span>
<span class="p">};</span>


<span class="c1">// Credentials data object
</span><span class="k">struct</span> <span class="n">CassandraCredentials</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">string</span> <span class="n">username</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">string</span> <span class="n">password</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Interface to Cassandra keyspaces. Allows reading and writing of objects.
</span><span class="k">class</span> <span class="nc">CassandraSingleton</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">CassandraSingleton</span><span class="p">();</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">CassandraSingleton</span><span class="p">();</span>

  <span class="k">static</span> <span class="kt">void</span> <span class="n">configure</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">hosts</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">password</span><span class="p">);</span>
  <span class="k">static</span> <span class="kt">void</span> <span class="n">teardown</span><span class="p">();</span>

  <span class="c1">// Basic Operations
</span>  <span class="c1">// Writes returns status of write if succeeds otherwise errors with error message
</span>  <span class="k">static</span> <span class="kt">bool</span> <span class="n">cassandra_write</span><span class="p">(</span><span class="n">CassStatement</span> <span class="o">*</span><span class="n">statement</span><span class="p">,</span> <span class="n">string</span> <span class="o">*</span><span class="n">error</span><span class="p">);</span>
  <span class="c1">// Reads will return a future to get results and throws exception on error.
</span>  <span class="c1">// Fails as likely SELECT was written incorrectly and you should know ASAP
</span>  <span class="k">static</span> <span class="n">CassFuture</span> <span class="o">*</span><span class="n">cassandra_select</span><span class="p">(</span><span class="n">CassStatement</span> <span class="o">*</span><span class="n">statement</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
  <span class="c1">// Initialize the session to be used
</span>  <span class="k">static</span> <span class="kt">void</span> <span class="n">initialize_connection</span><span class="p">();</span>

  <span class="k">static</span> <span class="n">string</span> <span class="n">hosts_</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">string</span> <span class="n">user_</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">string</span> <span class="n">password_</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialized_</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">CassCluster</span> <span class="o">*</span><span class="n">cluster_</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">CassSession</span> <span class="o">*</span><span class="n">session_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>And finally the definition <code>cassandra_singleton.cc</code>:</p>
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include "cassandra_singleton.h"
</span>
<span class="cp">#include &lt;glog/logging.h&gt;
</span>
<span class="n">string</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">hosts_</span><span class="p">;</span>
<span class="n">string</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">user_</span><span class="p">;</span>
<span class="n">string</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">password_</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">initialized_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">CassCluster</span> <span class="o">*</span><span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">cluster_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">// Note: This can be shared across threads
</span><span class="n">CassSession</span> <span class="o">*</span><span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">session_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">// Note: This can be shared across threads
</span>
<span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">CassandraSingleton</span><span class="p">()</span> <span class="p">{}</span>

<span class="n">CassandraSingleton</span><span class="o">::~</span><span class="n">CassandraSingleton</span><span class="p">()</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">configure</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">hosts</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">password</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">hosts_</span> <span class="o">=</span> <span class="n">hosts</span><span class="p">;</span>
  <span class="n">user_</span> <span class="o">=</span> <span class="n">user</span><span class="p">;</span>
  <span class="n">password_</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span> <span class="n">initialize_connection</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">teardown</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Close the session
</span>  <span class="n">CassFuture</span> <span class="o">*</span><span class="n">close_future</span> <span class="o">=</span> <span class="n">cass_session_close</span><span class="p">(</span><span class="n">session_</span><span class="p">);</span>
  <span class="n">cass_future_wait</span><span class="p">(</span><span class="n">close_future</span><span class="p">);</span>
  <span class="n">cass_future_free</span><span class="p">(</span><span class="n">close_future</span><span class="p">);</span>

  <span class="c1">// Free cluster and session
</span>  <span class="n">cass_cluster_free</span><span class="p">(</span><span class="n">cluster_</span><span class="p">);</span>
  <span class="n">cass_session_free</span><span class="p">(</span><span class="n">session_</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="p">{</span>
  <span class="c1">// Callback for Cassandra authentication to initiate authentication exchange
</span>  <span class="c1">// See initialize_connection for callbacks
</span>  <span class="kt">void</span> <span class="n">on_auth_initial</span><span class="p">(</span><span class="n">CassAuthenticator</span> <span class="o">*</span><span class="n">auth</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">CassandraCredentials</span><span class="o">*</span> <span class="n">credentials</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">CassandraCredentials</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">username_size</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="kt">size_t</span> <span class="n">password_size</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">username_size</span> <span class="o">+</span> <span class="n">password_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="n">cass_authenticator_response</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="c1">// Credentials are prefixed with '\0'
</span>    <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">response</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">credentials</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">username_size</span><span class="p">);</span>

    <span class="n">response</span><span class="p">[</span><span class="n">username_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">response</span> <span class="o">+</span> <span class="n">username_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">credentials</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">password_size</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">initialize_connection</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">cluster_</span> <span class="o">=</span> <span class="n">cass_cluster_new</span><span class="p">();</span>
  <span class="n">session_</span> <span class="o">=</span> <span class="n">cass_session_new</span><span class="p">();</span>
  <span class="n">cass_cluster_set_contact_points</span><span class="p">(</span><span class="n">cluster_</span><span class="p">,</span> <span class="n">hosts_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

  <span class="c1">// Callbacks initial, challenge, success, cleanup
</span>  <span class="c1">// Only initial needed for simple auth as other fields are used for
</span>  <span class="c1">// other systems like Kerberos etc
</span>  <span class="n">CassAuthenticatorCallbacks</span> <span class="n">auth_cbs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">on_auth_initial</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
  <span class="n">CassandraCredentials</span> <span class="n">credentials</span> <span class="o">=</span> <span class="p">{</span> <span class="n">user_</span><span class="p">,</span> <span class="n">password_</span> <span class="p">};</span>

  <span class="n">cass_cluster_set_authenticator_callbacks</span><span class="p">(</span><span class="n">cluster_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auth_cbs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">credentials</span><span class="p">);</span>
  <span class="n">CassFuture</span> <span class="o">*</span><span class="n">connect_future</span> <span class="o">=</span> <span class="n">cass_session_connect</span><span class="p">(</span><span class="n">session_</span><span class="p">,</span> <span class="n">cluster_</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cass_future_error_code</span><span class="p">(</span><span class="n">connect_future</span><span class="p">)</span> <span class="o">==</span> <span class="n">CASS_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">initialized_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"Connected to Cassandra for hosts "</span> <span class="o">&lt;&lt;</span> <span class="n">hosts_</span><span class="p">;</span>
    <span class="n">cass_future_free</span><span class="p">(</span><span class="n">connect_future</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Errored so grab message and throw exception
</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">message_length</span><span class="p">;</span>
  <span class="n">cass_future_error_message</span><span class="p">(</span><span class="n">connect_future</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message_length</span><span class="p">);</span>
  <span class="n">CassandraException</span> <span class="n">exception</span><span class="p">;</span>
  <span class="n">exception</span><span class="p">.</span><span class="n">error_msg_</span> <span class="o">=</span> <span class="s">"Could not connect to Cassandra database: "</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">exception</span><span class="p">.</span><span class="n">error_msg_</span><span class="p">;</span>
  <span class="n">cass_future_free</span><span class="p">(</span><span class="n">connect_future</span><span class="p">);</span>
  <span class="k">throw</span> <span class="n">exception</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">cassandra_write</span><span class="p">(</span><span class="n">CassStatement</span> <span class="o">*</span><span class="n">statement</span><span class="p">,</span> <span class="n">string</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">CassFuture</span><span class="o">*</span> <span class="n">future</span> <span class="o">=</span> <span class="n">cass_session_execute</span><span class="p">(</span><span class="n">session_</span><span class="p">,</span> <span class="n">statement</span><span class="p">);</span>
  <span class="n">cass_future_wait</span><span class="p">(</span><span class="n">future</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cass_future_error_code</span><span class="p">(</span><span class="n">future</span><span class="p">)</span> <span class="o">==</span> <span class="n">CASS_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cass_future_free</span><span class="p">(</span><span class="n">future</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Errored so grab message and return up
</span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">message</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">message_length</span><span class="p">;</span>
  <span class="n">cass_future_error_message</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message_length</span><span class="p">);</span>
  <span class="n">error</span><span class="o">-&gt;</span><span class="n">assign</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="n">cass_future_free</span><span class="p">(</span><span class="n">future</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CassFuture</span> <span class="o">*</span><span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">cassandra_select</span><span class="p">(</span><span class="n">CassStatement</span> <span class="o">*</span><span class="n">statement</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">CassFuture</span> <span class="o">*</span><span class="n">future</span> <span class="o">=</span> <span class="n">cass_session_execute</span><span class="p">(</span><span class="n">session_</span><span class="p">,</span> <span class="n">statement</span><span class="p">);</span>
  <span class="n">cass_future_wait</span><span class="p">(</span><span class="n">future</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cass_future_error_code</span><span class="p">(</span><span class="n">future</span><span class="p">)</span> <span class="o">==</span> <span class="n">CASS_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">future</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Errored so grab message and throw exception
</span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">message</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">message_length</span><span class="p">;</span>
  <span class="n">cass_future_error_message</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message_length</span><span class="p">);</span>
  <span class="n">CassandraException</span> <span class="n">exception</span><span class="p">;</span>
  <span class="n">exception</span><span class="p">.</span><span class="n">error_msg_</span> <span class="o">=</span> <span class="s">"SELECT failed for Cassandra query: "</span> <span class="o">+</span> <span class="n">string</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">exception</span><span class="p">.</span><span class="n">error_msg_</span><span class="p">;</span>
  <span class="n">cass_future_free</span><span class="p">(</span><span class="n">future</span><span class="p">);</span>
  <span class="k">throw</span> <span class="n">exception</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>I&#39;ve extracted the &quot;write&quot; and &quot;select&quot; pretty much since overall constructing the statement and then passing it to
something to handle the future and message seemed modular enough.</p>

<h3>Writing</h3>

<p>An example call for <code>INSERT</code> might look like:</p>
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="n">string</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"INSERT INTO experimentapp.users (id, name, email) VALUES (?, ?, ?)"</span><span class="p">;</span>
<span class="n">CassStatement</span> <span class="o">*</span><span class="n">statement</span> <span class="o">=</span> <span class="n">cass_statement_new</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">cass_statement_bind_int64</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>  <span class="c1">// Note: id, name, email initialized elsewhere
</span><span class="n">cass_statement_bind_string</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="n">cass_statement_bind_string</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">email</span><span class="p">);</span>
<span class="n">string</span> <span class="n">error</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="n">CassandraSingleton</span><span class="o">::</span><span class="n">cassandra_write</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="n">cass_statement_free</span><span class="p">(</span><span class="n">statement</span><span class="p">);</span>
</code></pre></div>
<h3>Reading</h3>

<p>An example call for <code>SELECT</code> might look like:</p>
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="n">string</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"SELECT * FROM experimentapp.users WHERE id = ?"</span><span class="p">;</span>
<span class="n">CassStatement</span> <span class="o">*</span><span class="n">statement</span> <span class="o">=</span> <span class="n">cass_statement_new</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">cass_statement_bind_int64</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="n">CassFuture</span> <span class="o">*</span><span class="n">future</span> <span class="o">=</span> <span class="n">cassandra_select</span><span class="p">(</span><span class="n">statement</span><span class="p">);</span>
<span class="k">const</span> <span class="n">CassResult</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">cass_future_get_result</span><span class="p">(</span><span class="n">future</span><span class="p">);</span>
<span class="n">CassIterator</span> <span class="o">*</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">cass_iterator_from_result</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="n">cass_iterator_next</span><span class="p">(</span><span class="n">iterator</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">CassRow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="n">cass_iterator_get_row</span><span class="p">(</span><span class="n">iterator</span><span class="p">);</span>
  <span class="c1">// .. Get your data from the row ..
</span><span class="p">}</span>
<span class="n">cass_future_free</span><span class="p">(</span><span class="n">future</span><span class="p">);</span>
<span class="n">cass_result_free</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="n">cass_iterator_free</span><span class="p">(</span><span class="n">iterator</span><span class="p">);</span>
</code></pre></div>
<p>You can even go as far as refactoring this so that you have a method that either takes in a lambda or you can store
the data in some structure and return that instead. Unfortunately though, since there&#39;s more objects needed for
retrieval of results and clean up it isn&#39;t as easy to pull it out and remove the &quot;behind the scene&quot; objects like the
future and such.</p>

<h2>Conclusion</h2>

<p>Well, I hope this helps someone! Let me know if it does as I always like being able to talk about these things but
sometimes it&#39;s hard to find time to write these things up or it doesn&#39;t feel as worthwhile but since I spent some
time digging around, figured this could help others learn a bit about setting up Cassandra!</p>

<p>All this was compiled from various documents on <a href="https://www.datastax.com/dev/blog/getting-started-with-the-datastax-c-driver">DataStax</a>, <a href="https://github.com/datastax/cpp-driver">DataStax driver repository</a>,
and <a href="http://cassandra.apache.org/doc/latest/">Cassandra&#39;s documentation</a>.</p>

  <!-- Page Navigation -->
  <div id="post-navigation">
    
      <div class="post-link left-post">
        <div class="sub-nav">Previous Post</div>
        <a href="https://www.richardhsu.me/posts/2015/05/10/separated-storyboards.html">Separated Storyboards for Tab Bar Controllers</a>
      </div>
    
    
  </div>

  
  <br />
  <br />
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'richardhsu'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
</div>

      <!-- /End Posts Listing -->
      <br />
      <div class="center">
        <a href="http://fontawesome.io">Font Awesome</a> by Dave Gandy
      </div>
      <br />
      <div>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- responsive -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-0877100694764684"
             data-ad-slot="5749193711"
             data-ad-format="auto"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
    </div>
  </div>
</div>
<!-- Tracking Code -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51347261-1', 'richardhsu.me');
  ga('send', 'pageview');
</script>
<!-- /Tracking Code -->
</body>
</html>
